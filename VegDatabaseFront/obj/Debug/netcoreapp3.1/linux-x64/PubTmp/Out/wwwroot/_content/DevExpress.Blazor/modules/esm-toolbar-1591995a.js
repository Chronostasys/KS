import"./esm-chunk-eaca7b99.js";import{EnsureElement as t,findParentBySelector as e,calculateStyles as i,AddClassNameToElement as s,RemoveClassNameFromElement as r,RequestAnimationFrame as n,SetStylesCore as a,subscribeElementContentWidth as o,unsubscribeElementContentWidth as l,PxToInt as h,GetCurrentStyle as u,ElementHasCssClass as d}from"./esm-dom-utils-0302a1f6.js";import"./esm-chunk-5735fd9a.js";import{D as c}from"./esm-chunk-b0b509fc.js";import"./esm-chunk-95f7350d.js";import{AttachEventsForFocusHiding as m}from"./esm-focus-utils-295d95eb.js";import{S as p}from"./esm-chunk-7b277b5c.js";class g{constructor(t,e){if(!e)throw new Error("Collection should be able to create item");this.items=[],this.itemCreateFunc=e,this.subscriptions=[],this.isLocked=!1,this.isCollection=!0,this.subjectsCache={},t&&this.addRange(t)}subscribe(t){this.isLocked||t(this.getChanges(this.items)),this.subscriptions.push(t)}getChanges(t,e){return{addedItems:t||[],removedItems:e||[]}}forEach(t){this.items.forEach(t)}selectMany(t){return this.map(t).reduce((function(t,e){return t.concat(e.items||e)}),[])}reduce(t,e){return this.items.reduce(t)}map(t){return this.items.map(t)}filter(t){return this.items.filter(t)}any(){return this.count()>0}count(){return this.items.length}countAsSubject(){return this.getMethodAsSubject(this.count)}withSorting(t){return new Components.SortedCollection(this,t)}withGrouping(t){return new Components.GroupedCollection(this,t)}withFilter(t){return new Components.FilteredCollection(this,t)}withMapping(t){return new Components.MappedCollection(this,t)}anyAsSubject(t){return t?this.withFilter(t).anyAsSubject():this.getMethodAsSubject(this.any)}getMethodAsSubject(t){if(!this.subjectsCache[t]){var e=t.bind(this),i=this.subjectsCache[t]=new Components.Subject(e());this.subscribe((function(){i.setValue(e())}))}return this.subjectsCache[t]}get(t){return this.items[t]}add(t){this.addItemCore(t)&&this.raiseChanges([t],[])}remove(t){this.removeItemCore(t)&&this.raiseChanges([],[t])}addRange(t){this.raiseChanges(t.map(this.addItemCore.bind(this)).filter((function(t){return!!t})),[])}removeRange(t){this.raiseChanges([],t.map(this.removeItemCore.bind(this)).filter((function(t){return!!t})))}addItemCore(t){return this.items.indexOf(t)>-1?null:this.items[this.items.length]=t}removeItemCore(t){var e=this.items.indexOf(t);return-1===e?null:this.items.splice(e,1)}raiseChanges(t,e){var i=this.getChanges(t,e);(i.addedItems.length>0||i.removedItems.length>0)&&this.subscriptions.forEach((function(t){t(i)}))}serialize(){var t=Array(this.items.length),e=!1,i=getIndexSequence(this.items.length-1);return(e=serialize(this.items,t,i)||e)?t:void 0}update(t){var e=t.length<this.items.length?this.items.splice(t.length):[],i=getIndexSequence(Math.max(-1,t.length-this.items.length-1)).map(function(e){var i=e+this.items.length;return this.itemCreateFunc(i,t[i])}.bind(this));this.items=this.items.concat(i),deserialize(t,this.items,getIndexSequence(this.items.length-1)),this.raiseChanges(i,e)}lock(){this.isLocked=!0}unlock(){this.isLocked=!1}}class f{constructor(t,e,i){this.block=e,this.layer=t,this.width=0,i.subscribe(e,function(t,i){null===t&&(t=this.layer.getPrevLayer().getActualBlocks().filter((function(t){return t.block===e}))[0].width),t!==this.width&&(this.width=t,i||this.layer.requestUpdateLayoutModel())}.bind(this))}getMinWidth(){return this.width}getMaxWidth(){return this.getMinWidth()}}class b extends f{getMaxWidth(t){return t===this.layer?this.layer.getPrevLayer().getActualBlocks().filter(function(t){return t.block===this.block}.bind(this))[0].getMinWidth():this.getMinWidth()}}class y extends f{}class I extends f{}class v{constructor(t,e){this.widthCalculator=t,this.triggersResolver=e}subscribe(t,e){var s=this.widthCalculator.bind(this);this.triggersResolver(t).forEach((function(r){r.subscribe((function(){t.isWidthCalculationLocked||i((function(){e(s(t))}))}),!0)})),i((function(){e(s(t),!0)}))}}var x={fullWidthItem:new v((function(t){return t.getWidth()}),H),fullWidthSystemItem:new v((function(t){return t.getWidth()}),(function(t){return[]})),titleItem:new v((function(t){return t.getWidth()}),(function(t){return[t.toolbar.title.HasTitle,t.toolbar.title.Text]})),noTextItem:new v((function(t){return t.getNoTextWidth()}),H),contextItem:function(t){return new v((function(e){return t.items.filter((function(t){return"item"===t.getName()&&t.index<e.index&&t.isVisible()})).length>=e.toolbar.MinRootItems||!e.isVisible()?0:null}),H)},hiddenItem:new v((function(){return 0}),(function(){return[]}))};class C{constructor(t,e,i,s){this.stateName=t,this.nextLayer=null,this.prevLayer=i,i&&(i.nextLayer=this),this.layoutBlocks=[],this.blockUpdaterGetter=e,this.latestRange=null,this.canApply=s}getNextLayer(){return null!=this.nextLayer?this.nextLayer.canApply()?this.nextLayer:this.nextLayer.getNextLayer():null}getPrevLayer(){return null!=this.prevLayer?this.prevLayer.canApply()?this.prevLayer:this.prevLayer.getPrevLayer():null}requestUpdateLayoutModel(){this.getPrevLayer().requestUpdateLayoutModel()}isValidWidth(t){if(!this.canApply())return!1;var e=this.getRange();return!this.getNextLayer()&&e.min>t||!this.getPrevLayer()&&e.max<t||e.min<=t&&e.max>=t}getRange(){return this.latestRange=this.getActualBlocks().reduce(function(t,e){return{min:t.min+e.getMinWidth(),max:t.max+e.getMaxWidth(this)}}.bind(this),{min:0,max:0})}getActualBlocks(){return this.getPrevLayer()?this.getPrevLayer().getActualBlocks().map(function(t){return this.layoutBlocks.filter((function(e){return e.block===t.block}))[0]||t}.bind(this)):this.layoutBlocks}activate(t){this.layoutBlocks.forEach(function(t){t.block.updateStateCore(this.stateName)}.bind(this))}addBlock(t){var e=this.blockUpdaterGetter(t);e&&this.layoutBlocks.push(this.createBlock(t,e))}removeBlock(t){}createBlock(t,e){}}class k extends C{constructor(t,e,i,s){super(t,e,null,s),this.layoutModel=i}requestUpdateLayoutModel(){this.layoutModel.updateLayout()}createBlock(t,e){return new I(this,t,e)}}class L extends C{activate(t){for(var e=this.getActualBlocks(),i=this.latestRange.max,s=this.stateName,r=e.length-1;r>=0;r--){var n=e[r];if(i>t)if((i-=n.getMaxWidth(this)-n.getMinWidth())<=t){n.block.updateStateCore(s),s=this.getPrevLayer().stateName;continue}n.block.updateStateCore(s)}}getRange(){return this.latestRange=this.getActualBlocks().reduce(function(t,e){return{min:t.min+e.getMinWidth(),max:t.max+e.getMaxWidth(this)}}.bind(this),{min:0,max:0})}createBlock(t,e){return new b(this,t,e)}}class w extends C{createBlock(t,e){return new y(this,t,e)}getRange(){return this.latestRange={min:this.getActualBlocks().reduce((function(t,e){return t+e.getMinWidth()}),0),max:this.getPrevLayer().getRange().max-1}}}class M{constructor(t){this.layers=[],this.currentWidth=null,this.onLayerApplied=t}initialize(t,e,i){this.elementContentWidthSubscription=o(e,e=>{this.currentWidth!==e&&(null===this.currentWidth&&t.subscribe(function(t){t.addedItems.forEach(this.addBlock.bind(this)),t.removedItems.forEach(this.removeBlock.bind(this))}.bind(this)),this.currentWidth=e,this.updateLayout(),i&&i())})}dispose(){this.elementContentWidthSubscription&&l(this.elementContentWidthSubscription)}getLastLayer(){return this.layers[this.layers.length-1]||null}defaultLayer(t,e){this.layers.push(new k("default",t,this,e))}simultaneousTransitionLayer(t,e,i){this.layers.push(new w(t,e,this.getLastLayer(),i))}sequentialTransitionLayer(t,e,i){this.layers.push(new L(t,e,this.getLastLayer(),i))}addBlock(t){this.layers.forEach((function(e){e.addBlock(t)}))}removeBlock(t){this.layers.forEach((function(e){e.removeBlock(t)}))}updateLayout(){var t=this.findLayersForWidth(this.currentWidth);t.length>0&&this.applyLayer(t[0])}resetToDefault(){this.applyLayer(this.layers[0])}applyLayer(t){t.activate(this.currentWidth),this.onLayerApplied&&this.onLayerApplied(t)}findLayersForWidth(t){return this.layers.filter((function(e){return e.isValidWidth(t)}))}forceUpdate(){null!==this.currentWidth&&this.updateLayout()}}class W extends class{constructor(){this.state=null,this.isWidthCalculationLocked=!1}updateStateCore(t){this.state=t,this.updateState(t)}updateState(t){}getElement(){}getGlobalRefreshTrigger(){}}{constructor(t,e){super(),this.element=e,this.toolbar=t}getWidth(){return this.isVisible()?G(this.getElement()):0}isVisible(){return!0}getName(){}getElement(){return this.element}getGlobalRefreshTrigger(){return this.toolbar.RefreshTrigger}}class S extends W{constructor(t,e){super(t),this.item=e,this.index=-1}getElement(){return this.item.getElement()}updateState(t){this.item.IsDisplayed.update(t.indexOf("has-"+this.getName())>-1)}}class T extends S{constructor(t,e){super(t,e)}getNoTextWidth(){return this.item.IsDisplayed.value?function(t){var e=G(t);if(t){var i=t.querySelector(".image");if(i){e-=z(i);for(var s=i;s=s.nextElementSibling;)d(s,"popout")||"absolute"===u(s).position||(e-=G(s))}}return e}(this.getElement()):0}getName(){return"item"}isVisible(){return this.item.IsDisplayed.value}updateState(t){var e=this.item.toolbar;this.updateVisible(e.MinRootItems>0?-1===t.indexOf("has-ellipsis")||this.index<e.MinRootItems:-1===t.indexOf("has-ellipsis")&&-1===t.indexOf("has-sidemenu"))}updateVisible(t){t||(this.isWidthCalculationLocked=!0),this.item.updateVisible(t),t&&(this.isWidthCalculationLocked=!1)}}class R extends S{constructor(t,e){super(t,e)}getName(){return"ellipsis"}updateState(t){S.prototype.updateState.call(this,t),this.updateVisible(this.item.IsDisplayed.value)}updateVisible(t){t||(this.isWidthCalculationLocked=!0),this.item.updateVisible(t),t&&(this.isWidthCalculationLocked=!1)}}class E extends T{constructor(t,e){super(t,e),this.itemBlocks=[],this.addItem(e)}addItem(t){this.itemBlocks.push(new T(this.toolbar,t))}isVisible(){return this.itemBlocks.reduce((function(t,e){return t&&e.isVisible()}),!0)}getWidth(){return this.itemBlocks.reduce((function(t,e){return t+e.getWidth()}),0)}getNoTextWidth(){return this.itemBlocks.reduce((function(t,e){return t+e.getNoTextWidth()}),0)}updateVisible(t){this.itemBlocks.forEach((function(e){e.updateVisible(t)}))}tryAddItem(t){var e,i=this.itemBlocks[this.itemBlocks.length-1].item;return(e=i.GroupName===t.GroupName&&i.group===t.group&&i.AdaptivePriority.value===t.AdaptivePriority.value)&&this.addItem(t),e}}class A extends W{constructor(t,e,i){super(t,e),this.item=i}getName(){return"title"}getWidth(){return G(this.getElement(),!0)}getElement(){return this.item.getElement()}}class B{constructor(t,e){this.element=t,this.toolbar=e,this.isVisible=!0,this.IsVisible=new p(null),this.IsVisible.subscribe(function(t){this.onIsVisibleChanged(t)}.bind(this),!0)}getElement(){return this.element}updateVisible(t){this.IsVisible.update(t)}onIsVisibleChanged(t){var e=this.getElement();e&&(t?this.show(e):this.hide(e))}show(t){t.classList.remove("ta-hidden-item")}hide(t){t.classList.add("ta-hidden-item")}}class N extends B{constructor(t,e,i){super(t,i),this.group=e,this.IsDisplayed=new p(!0),this.Text=new p,this.GroupName=new p,this.AdaptivePriority=new p,this.Index=new p,this.IconCssClass=new p}onIsVisibleChanged(t){super.onIsVisibleChanged(t),this.group.onItemVisibleChanged()}getElement(){return document.querySelector(U("data-dxtoolbar-item-id",this.Id))}getParent(){var t=this.getElement();if(t&&t.parentNode)return t.parentNode}}class V extends B{constructor(t,e){super(t,e),this.items=[]}addItem(t){this.items.push(t)}onItemVisibleChanged(){if(0!==this.items.length){var t=this.items.some(t=>t.IsVisible.value);this.updateVisible(t)}}getElement(){if(0===this.items.length)return null;var t=e(this.items[0].getElement(),U("data-dxtoolbar-group-id",this.toolbar.id));return t||this.items[0].getParent()}}class P{constructor(t){this.element=t,this._refreshTrigger=new p(!1),this.itemMap=new Map,this.groupMap=new Map,this.items=[]}setEllipses(t){this.ellipses=t}get RefreshTrigger(){return this._refreshTrigger.asTrigger(t=>!t)}refresh(){this._refreshTrigger.update(this.refreshTrigger.value)}}class q extends B{constructor(t,e){super(t,e),this.toolbar=e,this.element=t,this.IsDisplayed=new p(!0),this.Text=new p,this.IsVisible.update(!1)}}class j extends B{constructor(t,e,i){super(t,e),this.toolbar=e,this.HasTitle=new p,this.Text=new p,this.Text.subscribe(function(t){this.HasTitle.update(null!=t&&""!=t)}.bind(this)),this.elementSelector=i}getElement(){return document.querySelector(this.elementSelector)}}class D{constructor(){this.IsLoading=!0}init(t,n){this.isLayoutCalculated=!1;var a=n.dotNetComponentReference,o=t.dataset.dxtoolbarId,l=U("data-dxtoolbar-title-id",o),h=U("data-dxtoolbar-ellipses-id",o),u=document.querySelector(h),d=this.toolbar=new P(t),c=d.groupMap;d.id=o,Array.from(n.items).forEach((t,i)=>{var s=document.querySelector(U("data-dxtoolbar-item-id",t.id));let r=e(s,U("data-dxtoolbar-group-id",o)),n=null;c.has(r)?n=c.get(r):(n=new V(r,d),c.set(r,n));var a=new N(s,n,d);a.Text.update(t.text),a.GroupName.update(t.groupName),a.AdaptivePriority.update(t.adaptivePriority),a.IconCssClass.update(t.iconCssClass),a.IsDisplayed.update(t.visible),a.Index.update(t.index),a.Id=t.id,d.itemMap.set(a.Id,a),d.items.some(t=>t.Index.value==a.Index.value)||(n.addItem(a),d.items.push(a))}),d.setEllipses(u),d.CanHideRootItems=n.canHideRootItems,d.CanCollapseToIcons=n.canCollapseToIcons,d.MinRootItems=n.minRootItems,d.ItemSize=n.itemSize;var m=new g([],t=>{});d.title=new j(d.title,d,l),m.add(new A(d,d.title,d.title)),m.addRange(this.getItemsBlocks(d,new g(Array.from(c.values()),(function(){})))),m.add(new R(d,new q(d.ellipses,d)));var p=x.contextItem(m),f=this.Model=new M(function(e){if(!this.isLayoutCalculated){this.isLayoutCalculated=!0;var n=d.element;i(function(){var t=n.querySelector(".btn-toolbar");this.updateControlStyles(d,Math.ceil(!this.IsLoading&&t?t.offsetHeight:n.offsetHeight)),this.IsLoading=!1,this.trackToolbarControl(this)}.bind(this))}e.stateName.indexOf("no-item-text")>-1?s(d.element,"no-item-text"):r(d.element,"no-item-text"),r(t,"dxbs-loading");var o=d.items.map(t=>({Index:parseInt(t.Index.value),Hidden:!t.IsVisible.value}));a.invokeMethodAsync("OnModelUpdated",Array.from(o))}.bind(this));f.defaultLayer((function(t){switch(t.getName()){case"item":return x.fullWidthItem;case"title":return x.titleItem}return x.hiddenItem}),()=>!0),f.sequentialTransitionLayer("has-ellipsis",(function(t){switch(t.getName()){case"ellipsis":return x.fullWidthSystemItem;case"item":return p}}),()=>d.CanHideRootItems&&d.MinRootItems>0),f.simultaneousTransitionLayer("no-item-text",(function(t){switch(t.getName()){case"item":return x.noTextItem;case"ellipsis":return x.hiddenItem}}),()=>d.CanCollapseToIcons),f.sequentialTransitionLayer(d.CanCollapseToIcons?"no-item-text has-ellipsis":"has-ellipsis",(function(t){switch(t.getName()){case"item":return p;case"ellipsis":return x.fullWidthSystemItem}}),()=>d.CanHideRootItems),f.initialize(m,d.element,function(){}.bind(this)),this.layoutModel=f}reinit(t){this.reinitRequested||(this.reinitRequested=!0,n(function(){this.reinitRequested=!1,this.resetToDefault(),this.disposeModel(),n(function(){this.init(t.mainElement,t)}.bind(this))}.bind(this)))}resetToDefault(){this.layoutModel.resetToDefault()}update(t){var e=!1;this.toolbar.CanHideRootItems!==t.canHideRootItems&&(this.toolbar.CanHideRootItems=t.canHideRootItems,e=!0),this.toolbar.CanCollapseToIcons!=t.canCollapseToIcons&&(this.toolbar.CanCollapseToIcons=t.canCollapseToIcons,e=!0),this.toolbar.MinRootItems!==t.minRootItems&&(this.toolbar.MinRootItems=t.minRootItems,e=!0),this.toolbar.ItemSize!==t.itemSize&&(this.toolbar.ItemSize=t.itemSize,this.isLayoutCalculated=!1,e=!0),this.toolbar.title.Text.update(t.title);var i,s,r=Array.from(t.items).map(t=>t.id),n=Array.from(this.toolbar.itemMap.values()).map(t=>t.Id);if(!((i=r).length==(s=n).length&&i.every((t,e)=>t===s[e])))return this.reinit(t),void 0;Array.from(t.items).forEach((t,e)=>{var i=this.toolbar.itemMap.get(t.id);i&&(i.Text.update(t.text),i.GroupName.update(t.groupName),i.AdaptivePriority.update(t.adaptivePriority),i.Index.update(t.index),i.IconCssClass.update(t.iconCssClass),i.IsDisplayed.update(t.visible))}),e&&this.layoutModel.forceUpdate()}disposeModel(){this.layoutModel&&this.layoutModel.dispose()}dispose(){this.disposeModel()}trackToolbarControl(t){}getItemsBlocks(t,e){return e.selectMany((function(t){return t.items})).reduce(function(e,i){return e.group&&e.group.tryAddItem(i)?e:i.GroupName?{group:e.blocks[e.blocks.length]=new E(t,i),blocks:e.blocks}:{group:null,blocks:e.blocks.concat([new T(t,i)])}}.bind(this),{blocks:[],group:null}).blocks.sort((function(t,e){return t.item.AdaptivePriority.value-e.item.AdaptivePriority.value})).map((function(t,e){return t.index=e,t}))}updateControlStyles(t,e){a(t.element,"height",e+"px")}}function H(t){return[t.item.Text,t.item.IsDisplayed,t.item.IconCssClass]}function G(t,e){var i=t?Math.ceil(t.offsetWidth+(e?0:z(t))):0;if(t){if(t.parentElement.lastElementChild===t){var s=u(t.parentElement);i+=h(s.marginRight)}if(t.parentElement.firstElementChild===t){s=u(t.parentElement);i+=h(s.marginLeft)}}return i}function z(t){return e=t,s=i||u(e),h(s.marginLeft)+h(s.marginRight);var e,i,s}function U(t,e){return`[${t}=${e}]`}var O=new Map;function F(e){var i=e.mainElement;if(null!==i){var s;if(i=t(i),c(i),s=O.get(i))s.update(e);else(s=new D).init(i,e),O.set(i,s);var r=i.querySelector(".btn-toolbar")||i;return m(r),Promise.resolve("ok")}}function _(e){if(e=t(e)){c(e);var i=O.get(e);i&&(i.dispose(),O.delete(e))}return Promise.resolve("ok")}const $={Init:F,Dispose:_};export default $;export{_ as Dispose,F as Init};
